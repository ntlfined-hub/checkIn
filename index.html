<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Check In ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{box-sizing:border-box;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
    .glass{background:rgba(255,255,255,.08);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.12)}
    .input{background:rgba(255,255,255,.06);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.15);color:#fff}
    .input:focus{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.3);box-shadow:0 0 0 3px rgba(255,255,255,.08)}
    .btn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25)}
    .btn:hover{background:rgba(255,255,255,.18);transform:translateY(-1px)}
    .pill{background:rgba(255,255,255,.1)}

    /* ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ dropdown ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
    select.input option{ color:#111; background:#fff; }
    /* (‡∏ö‡∏≤‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô Tailwind ‡πÉ‡∏ô popup ‡∏Ç‡∏≠‡∏á select ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏£‡∏á‡πÜ‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢) */
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-gray-900 to-zinc-900 text-white">
  <!-- glow bg -->
  <div class="fixed inset-0 pointer-events-none">
    <div class="absolute -top-40 -right-40 w-80 h-80 rounded-full blur-3xl bg-white/10"></div>
    <div class="absolute -bottom-40 -left-40 w-80 h-80 rounded-full blur-3xl bg-white/10"></div>
  </div>

  <div class="relative z-10 container mx-auto max-w-xl px-6 py-10">
    <!-- header -->
    <div class="text-center mb-10">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-white/10 border border-white/20 mb-5">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </div>
      <h1 class="text-3xl font-bold">Check In</h1>
      <p class="text-white/80">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å / ‡∏î‡∏π / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô</p>
    </div>

    <!-- checkin form -->
    <div class="glass rounded-3xl p-6 mb-8">
      <form id="checkinForm" class="space-y-6">
        <div>
          <label class="block text-sm font-semibold mb-2">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
          <select id="nameSelect" class="input w-full p-3 rounded-xl outline-none" required>
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</option>
            <option>Tow</option>
            <option>Kwan</option>
            <option>Noi</option>
            <option>Ray</option>
            <option>Cap</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
          <div class="flex pill rounded-2xl p-1">
            <button type="button" id="fullBtn" class="flex-1 py-2 rounded-xl bg-white/20 font-medium">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô</button>
            <button type="button" id="splitBtn" class="flex-1 py-2 rounded-xl text-white/90 font-medium">‡πÅ‡∏¢‡∏Å AM/PM</button>
          </div>
        </div>

        <div id="fullBox">
          <label class="block text-sm font-semibold mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)</label>
          <input id="fullLocation" type="text" value="Ari" class="input w-full p-3 rounded-xl outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô Ari">
          <p class="text-xs text-white/70 mt-1">* ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á AM ‡πÅ‡∏•‡∏∞ PM ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
        </div>

        <div id="splitBox" class="hidden space-y-4">
          <div>
            <label class="block text-sm font-semibold mb-2">üåÖ AM</label>
            <input id="amLocation" type="text" value="Ari" class="input w-full p-3 rounded-xl outline-none" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">üåÜ PM</label>
            <input id="pmLocation" type="text" value="Ari" class="input w-full p-3 rounded-xl outline-none" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢">
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input id="dateInput" type="date" class="input w-full p-3 rounded-xl outline-none" required>
          <p class="text-xs text-white/70 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</p>
        </div>

        <button id="checkinBtn" class="btn w-full py-3 rounded-2xl font-semibold flex items-center justify-center gap-2">
          <span>Check In</span>
        </button>
      </form>
    </div>

    <!-- view & edit -->
    <div class="glass rounded-3xl p-6">
      <div class="flex items-center gap-3 mb-4">
        <h2 class="text-xl font-semibold">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</h2>
      </div>
      <div class="flex gap-3 mb-5">
        <select id="viewName" class="input flex-1 p-3 rounded-xl outline-none">
          <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</option>
          <option>Tow</option>
          <option>Kwan</option>
          <option>Noi</option>
          <option>Ray</option>
          <option>Cap</option>
        </select>
        <button id="viewBtn" class="btn px-5 rounded-xl font-semibold">‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
      </div>

      <div id="scheduleWrap" class="hidden">
        <div id="scheduleList" class="space-y-3"></div>
      </div>
    </div>

    <!-- status -->
    <div id="status" class="hidden mt-6 p-4 rounded-2xl"></div>

    <!-- success popup -->
    <div id="popup" class="hidden fixed inset-0 z-50 items-center justify-center p-6">
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="relative glass rounded-3xl p-6 max-w-sm w-full text-center">
        <div class="w-14 h-14 rounded-2xl bg-green-500/20 mx-auto mb-4 flex items-center justify-center">
          <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h3 class="text-xl font-semibold mb-2">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
        <p id="popupMsg" class="text-white/90 mb-4"></p>
        <button onclick="closePopup()" class="btn w-full py-2 rounded-xl font-semibold">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== CONFIG ===== */
    const APP_SCRIPT_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxKmlulJgGnv8pUqbbOYlK5mRn6jZ_DdQQCKoJ3dExHWl62mDOPhDR5usWbSpC38gzH/exec';

    /* ===== UI Utils ===== */
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateInput').min = today;
    document.getElementById('dateInput').value = today;

    function toast(msg, type='info'){
      const el = document.getElementById('status');
      el.className = `mt-6 p-4 rounded-2xl ${type==='error'?'bg-red-500/20 border border-red-500/40':'bg-white/10 border border-white/20'}`;
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(()=>el.classList.add('hidden'), 4500);
    }
    function openPopup(text){ document.getElementById('popupMsg').textContent = text; document.getElementById('popup').classList.remove('hidden'); document.getElementById('popup').classList.add('flex');}
    function closePopup(){ document.getElementById('popup').classList.add('hidden'); document.getElementById('popup').classList.remove('flex'); }

    /* ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏™‡∏õ‡∏¥‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå */
    function setBtnLoading(btn, isLoading, labelWhenDone='‡πÄ‡∏™‡∏£‡πá‡∏à'){
      if(isLoading){
        btn.disabled = true;
        btn.dataset.prev = btn.innerHTML;
        btn.innerHTML = `
          <span class="inline-flex items-center gap-2">
            <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
          </span>`;
      }else{
        btn.disabled = false;
        btn.innerHTML = btn.dataset.prev || labelWhenDone;
      }
    }

    /* ===== Toggle AM/PM ===== */
    let splitMode = false;
    const fullBtn = document.getElementById('fullBtn');
    const splitBtn = document.getElementById('splitBtn');
    const fullBox = document.getElementById('fullBox');
    const splitBox = document.getElementById('splitBox');

    fullBtn.addEventListener('click', ()=>{
      splitMode = false;
      fullBtn.classList.add('bg-white/20'); splitBtn.classList.remove('bg-white/20');
      fullBox.classList.remove('hidden'); splitBox.classList.add('hidden');
    });
    splitBtn.addEventListener('click', ()=>{
      splitMode = true;
      splitBtn.classList.add('bg-white/20'); fullBtn.classList.remove('bg-white/20');
      splitBox.classList.remove('hidden'); fullBox.classList.add('hidden');
    });

    /* ===== API helper (FormData, no CORS preflight) ===== */
    async function callAPI(action, payload={}){
      const fd = new FormData();
      fd.append('action', action);
      fd.append('payload', JSON.stringify(payload));
      const res = await fetch(APP_SCRIPT_WEBAPP_URL, { method: 'POST', body: fd });
      const text = await res.text();
      try { return JSON.parse(text); } catch { return { ok:false, error:'Invalid JSON', raw:text }; }
    }

    /* ===== Submit Check-in ===== */
    const checkinBtn = document.getElementById('checkinBtn');
    document.getElementById('checkinForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('nameSelect').value.trim();
      const date = document.getElementById('dateInput').value;
      if(!name || !date){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô','error'); return; }
      if(date < today){ toast('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á','error'); return; }

      let payload;
      if(!splitMode){
        const loc = document.getElementById('fullLocation').value.trim();
        if(!loc){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô)','error'); return; }
        payload = { name, date, split:false, location:loc }; // GAS ‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô AM=PM ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      }else{
        const am = document.getElementById('amLocation').value.trim();
        const pm = document.getElementById('pmLocation').value.trim();
        if(!am || !pm){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á AM ‡πÅ‡∏•‡∏∞ PM','error'); return; }
        payload = { name, date, split:true, amLoc:am, pmLoc:pm };
      }

      try{
        setBtnLoading(checkinBtn, true);
        const {ok, upsert, error} = await callAPI('create', payload);
        if(!ok){ toast(error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); return; }
        openPopup(upsert ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        // reset
        document.getElementById('nameSelect').value = '';
        document.getElementById('fullLocation').value = 'Ari';
        document.getElementById('amLocation').value = 'Ari';
        document.getElementById('pmLocation').value = 'Ari';
        document.getElementById('dateInput').value = today;
      }catch(err){
        console.error(err); toast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠','error');
      }finally{
        setBtnLoading(checkinBtn, false, 'Check In');
      }
    });

    /* ===== View schedule ===== */
    document.getElementById('viewBtn').addEventListener('click', ()=> {
      const name = document.getElementById('viewName').value.trim();
      if(!name){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ','error'); return; }
      renderSchedule(name);
    });

    async function renderSchedule(name){
      const wrap = document.getElementById('scheduleWrap');
      const list = document.getElementById('scheduleList');
      wrap.classList.remove('hidden');
      list.innerHTML = `<div class="text-white/80">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;
      try{
        const {ok, items, error} = await callAPI('listFuture', { name, from: today });
        if(!ok){ list.innerHTML = `<div class="text-red-300">${error||'‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}</div>`; return; }
        if(!items || !items.length){
          list.innerHTML = `<div class="text-white/80">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</div>`;
          return;
        }
        list.innerHTML = items.map(row => renderItem(row)).join('');
      }catch(err){
        console.error(err);
        list.innerHTML = `<div class="text-white/80">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>`;
      }
    }

    function renderItem(entry){
      const locationDisplay = entry.split
        ? `<div class="text-sm text-white/90">üåÖ AM: ${entry.am || '-'}</div>
           <div class="text-sm text-white/90">üåÜ PM: ${entry.pm || '-'}</div>`
        : `<div class="text-sm text-white/90">${entry.location || entry.am || '-'}</div>`;

      return `
        <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-semibold">${formatThai(entry.date)}</div>
              ${locationDisplay}
            </div>
            <button class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20" onclick="openEdit('${entry.rowId}', ${entry.split ? 'true':'false'}, '${entry.date}', '${escapeHTML(entry.am||'')}', '${escapeHTML(entry.pm||'')}', '${escapeHTML(entry.location||'')}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </div>
          <div id="edit-${entry.rowId}" class="hidden mt-4 pt-4 border-t border-white/10"></div>
        </div>`;
    }

    function formatThai(iso){
      const d = new Date(iso);
      const months = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
      return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()+543}`;
    }

    function escapeHTML(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    /* ===== Edit UI & Save ===== */
    window.openEdit = function(rowId, split, date, am, pm, location){
      const box = document.getElementById(`edit-${rowId}`);
      const isSplit = !!split;
      box.innerHTML = `
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="ed-date-${rowId}" class="input w-full p-3 rounded-xl" value="${date}" min="${today}">
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
            <div class="flex pill rounded-2xl p-1">
              <button type="button" id="ed-full-${rowId}" class="flex-1 py-2 rounded-xl ${!isSplit?'bg-white/20':''}">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô</button>
              <button type="button" id="ed-split-${rowId}" class="flex-1 py-2 rounded-xl ${isSplit?'bg-white/20':''}">‡πÅ‡∏¢‡∏Å AM/PM</button>
            </div>
          </div>

          <div id="ed-fullBox-${rowId}" class="${isSplit?'hidden':''}">
            <label class="block text-sm font-semibold mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)</label>
            <input type="text" id="ed-fullLoc-${rowId}" class="input w-full p-3 rounded-xl" value="${location || am || ''}">
            <p class="text-xs text-white/70 mt-1">* ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AM ‡πÅ‡∏•‡∏∞ PM ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</p>
          </div>

          <div id="ed-splitBox-${rowId}" class="${isSplit?'':'hidden'} space-y-3">
            <div>
              <label class="block text-sm font-semibold mb-1">üåÖ AM</label>
              <input type="text" id="ed-am-${rowId}" class="input w-full p-3 rounded-xl" value="${am || ''}">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">üåÜ PM</label>
              <input type="text" id="ed-pm-${rowId}" class="input w-full p-3 rounded-xl" value="${pm || ''}">
            </div>
          </div>

          <div class="flex gap-3 pt-2">
            <button id="saveBtn-${rowId}" class="btn flex-1 py-2 rounded-xl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="bg-white/10 hover:bg-white/20 flex-1 py-2 rounded-xl" onclick="closeEdit('${rowId}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </div>
      `;
      box.classList.remove('hidden');

      // toggle inside editor
      document.getElementById(`ed-full-${rowId}`).onclick = ()=>{
        document.getElementById(`ed-full-${rowId}`).classList.add('bg-white/20');
        document.getElementById(`ed-split-${rowId}`).classList.remove('bg-white/20');
        document.getElementById(`ed-fullBox-${rowId}`).classList.remove('hidden');
        document.getElementById(`ed-splitBox-${rowId}`).classList.add('hidden');
      };
      document.getElementById(`ed-split-${rowId}`).onclick = ()=>{
        document.getElementById(`ed-split-${rowId}`).classList.add('bg-white/20');
        document.getElementById(`ed-full-${rowId}`).classList.remove('bg-white/20');
        document.getElementById(`ed-splitBox-${rowId}`).classList.remove('hidden');
        document.getElementById(`ed-fullBox-${rowId}`).classList.add('hidden');
      };

      // ‚úÖ save with loading
      document.getElementById(`saveBtn-${rowId}`).onclick = async (e)=>{
        e.preventDefault();
        await saveEdit(rowId);
      };
    };

    window.closeEdit = function(rowId){
      document.getElementById(`edit-${rowId}`).classList.add('hidden');
    };

    async function saveEdit(rowId){
      const date = document.getElementById(`ed-date-${rowId}`).value;
      if(!date){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','error'); return; }
      if(date < today){ toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ','error'); return; }

      // check which box visible
      const fullVisible = !document.getElementById(`ed-fullBox-${rowId}`).classList.contains('hidden');
      const saveBtn = document.getElementById(`saveBtn-${rowId}`);
      let payload = { rowId, date };

      if(fullVisible){
        const loc = document.getElementById(`ed-fullLoc-${rowId}`).value.trim();
        if(!loc){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô)','error'); return; }
        payload.split = false;
        payload.location = loc; // GAS ‡∏à‡∏∞ set AM=PM=loc ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      }else{
        const am = document.getElementById(`ed-am-${rowId}`).value.trim();
        const pm = document.getElementById(`ed-pm-${rowId}`).value.trim();
        if(!am || !pm){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á AM ‡πÅ‡∏•‡∏∞ PM','error'); return; }
        payload.split = true;
        payload.amLoc = am; payload.pmLoc = pm;
      }

      try{
        setBtnLoading(saveBtn, true);
        const {ok, error} = await callAPI('update', payload);
        if(!ok){ toast(error || '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); return; }
        openPopup('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        // refresh
        const name = document.getElementById('viewName').value.trim();
        if(name) renderSchedule(name);
      }catch(err){
        console.error(err); toast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠','error');
      }finally{
        setBtnLoading(saveBtn, false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
      }
    }
  </script>
</body>
</html>
