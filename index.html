<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Check In Fin-ed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --card-radius: 1.5rem;
      --input-radius: 0.9rem;
      --input-padding-y: 0.9rem;
      --input-padding-x: 1rem;
      --input-font-size: 1.05rem;
    }
    body{box-sizing:border-box;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
    .glass{background:rgba(255,255,255,.08);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.12)}
    .card{ border-radius:var(--card-radius); }

    .input{
      background:rgba(255,255,255,.06);
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.15);
      color:#fff;
      padding:var(--input-padding-y) var(--input-padding-x);
      border-radius:var(--input-radius);
      font-size:var(--input-font-size);
      width:100%;
    }
    .input:focus{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.3);box-shadow:0 0 0 3px rgba(255,255,255,.08);outline:none}
    select.input option{ color:#111; background:#fff; } /* ‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô dropdown */

    /* date input ‡∏™‡∏π‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á + ‡πÑ‡∏°‡πà‡∏ä‡∏ô‡∏Ç‡∏≠‡∏ö (iOS) */
    .input[type="date"], .input[type="time"]{ -webkit-appearance:none; appearance:none; line-height:1.65; }
    .input[type="date"]::-webkit-datetime-edit{ padding:.35rem .5rem; }
    .input[type="date"]::-webkit-datetime-edit-fields-wrapper{ padding:0 .25rem; }
    .input[type="date"]::-webkit-datetime-edit-text{ padding:0 .2rem; }
    .input[type="date"]::-webkit-calendar-picker-indicator,
    .input[type="time"]::-webkit-calendar-picker-indicator{ padding-right:.5rem; filter: invert(1) opacity(.85); }

    .btn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);transition:.2s;border-radius:var(--input-radius)}
    .btn:hover{background:rgba(255,255,255,.18);transform:translateY(-1px)}
    .btn-cta{background:linear-gradient(135deg,#10b981,#16a34a);border:0;box-shadow:0 12px 24px rgba(16,185,129,.25)}
    .btn-cta:hover{transform:translateY(-1.5px) scale(1.01);box-shadow:0 16px 30px rgba(16,185,129,.32)}
    .btn-cta:disabled{opacity:.85;filter:saturate(.85);box-shadow:none}
    .pill{background:rgba(255,255,255,.1);border-radius:calc(var(--input-radius) + .4rem)}
    .chip{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); }
    .chip:hover{ background:rgba(255,255,255,.12); }
    .mini-btn{ background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); }
    .mini-btn:hover{ background:rgba(255,255,255,.18); }

    /* Tabs */
    .tab-btn{border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06)}
    .tab-btn[aria-selected="true"]{ background:rgba(16,185,129,.18); border-color:rgba(16,185,129,.4) }
    .tab-panel{ display:none }
    .tab-panel.active{ display:block }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-gray-900 to-zinc-900 text-white">
  <!-- background glow -->
  <div class="fixed inset-0 pointer-events-none">
    <div class="absolute -top-40 -right-40 w-80 h-80 rounded-full blur-3xl bg-white/10"></div>
    <div class="absolute -bottom-40 -left-40 w-80 h-80 rounded-full blur-3xl bg-white/10"></div>
  </div>

  <div class="relative z-10 container mx-auto max-w-4xl px-6 py-10">
    <!-- header -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-white/10 border border-white/20 mb-5">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </div>
      <h1 class="text-3xl font-bold tracking-tight">Check In Fin-ed</h1>
    </div>

    <!-- TABS -->
    <div class="glass card p-2 mb-6">
      <div role="tablist" class="grid grid-cols-1 sm:grid-cols-3 gap-2">
        <button id="tab-1" role="tab" class="tab-btn rounded-xl py-3 font-semibold" aria-selected="true">Check In</button>
        <button id="tab-2" role="tab" class="tab-btn rounded-xl py-3 font-semibold" aria-selected="false">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</button>
        <button id="tab-3" role="tab" class="tab-btn rounded-xl py-3 font-semibold" aria-selected="false">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Check-in</button>
      </div>
    </div>

    <!-- ================= TAB 1: Check-in + bulk ================= -->
    <section id="panel-1" class="tab-panel active">
      <!-- form -->
      <div class="glass card p-6 mb-8">
        <form id="checkinForm" class="space-y-6">
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-2">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
              <select id="nameSelect" class="input" required>
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</option>
                <option>Tow</option><option>Kwan</option><option>Noi</option><option>Ray</option><option>Cap</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input id="dateInput" type="date" class="input" required>
              <p class="text-xs text-white/70 mt-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
            <div class="flex pill p-1">
              <button type="button" id="fullBtn" class="flex-1 py-2 rounded-xl bg-white/20 font-medium">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô</button>
              <button type="button" id="splitBtn" class="flex-1 py-2 rounded-xl text-white/90 font-medium">‡πÅ‡∏¢‡∏Å AM/PM</button>
            </div>
          </div>

          <div id="fullBox">
            <label class="block text-sm font-semibold mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)</label>
            <input id="fullLocation" type="text" value="Ari" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô Ari">
            <p class="text-xs text-white/70 mt-2">* ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å AM ‡πÅ‡∏•‡∏∞ PM ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
          </div>

          <div id="splitBox" class="hidden space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2">üåÖ AM</label>
              <input id="amLocation" type="text" value="Ari" class="input" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">üåÜ PM</label>
              <input id="pmLocation" type="text" value="Ari" class="input" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢">
            </div>
          </div>

          <!-- suggestions -->
          <div>
            <div class="flex items-center gap-2 mb-2">
              <span class="text-sm font-semibold">‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
              <span id="suggestLoading" class="text-xs text-white/70 hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</span>
            </div>
            <div id="suggestWrap" class="grid grid-cols-1 gap-2"></div>
            <p id="suggestEmpty" class="text-xs text-white/60 hidden">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
          </div>

          <button id="checkinBtn" class="btn btn-cta w-full py-3 font-semibold flex items-center justify-center gap-2">
            <span>Check In</span>
          </button>
        </form>
      </div>

      <!-- bulk create -->
      <div class="glass card p-6 mb-8">
        <h2 class="text-lg font-semibold mb-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à)</h2>
        <p class="text-white/70 text-sm mb-4">‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äú‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‚Äù ‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
          <button id="bulkThisWeek" class="btn px-4 py-3 font-semibold flex items-center justify-center gap-2">
            <span>‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</span>
          </button>
          <button id="bulkNextWeek" class="btn px-4 py-3 font-semibold flex items-center justify-center gap-2">
            <span>‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏´‡∏ô‡πâ‡∏≤</span>
          </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
          <div>
            <label class="block text-sm font-semibold mb-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input id="rangeStart" type="date" class="input">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input id="rangeEnd" type="date" class="input">
          </div>
        </div>
        <div class="mt-3">
          <button id="bulkRange" class="btn px-5 py-3 font-semibold flex items-center justify-center gap-2">
            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
          </button>
        </div>
        <p class="text-xs text-white/70 mt-3">* ‡πÇ‡∏´‡∏°‡∏î ‡∏à‚Äì‡∏® ‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏™‡∏≤‡∏£‡πå‚Äì‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡πÇ‡∏´‡∏°‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏±‡πâ‡∏ô</p>
      </div>
    </section>

    <!-- ================= TAB 2: Future schedule ================= -->
    <section id="panel-2" class="tab-panel">
      <div class="glass card p-6">
        <div class="mb-5">
  <h2 class="text-xl font-semibold mb-3">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</h2>

  <!-- ‡πÉ‡∏´‡πâ select ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô -->
  <div class="w-full">
    <select id="viewName" class="input w-full mb-3">
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</option>
      <option>Tow</option><option>Kwan</option><option>Noi</option><option>Ray</option><option>Cap</option>
    </select>

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° .btn-equal ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö input -->
    <button id="viewBtn" class="btn btn-equal w-full font-semibold block">
      ‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    </button>
  </div>
</div>

<div id="scheduleWrap" class="hidden">
  <div id="scheduleList" class="space-y-3"></div>
</div>
    </section>

    <!-- ================= TAB 3: Send to LINE ================= -->
    <section id="panel-3" class="tab-panel">
      <div class="glass card p-6">
        <h2 class="text-xl font-semibold mb-4">‡∏™‡πà‡∏á Check-in ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå</h2>

        <div class="grid lg:grid-cols-2 gap-6">
          <!-- left: send now -->
          <div class="rounded-2xl p-5 bg-white/5 border border-white/10">
            <h3 class="font-semibold mb-3">‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</h3>
            <div class="grid sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‚Äù ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ</label>
                <input id="sendDateInput" type="date" class="input">
              </div>
              <div class="sm:pt-7">
                <button id="sendNowBtn" class="btn w-full py-3 font-semibold flex items-center justify-center gap-2">
                  <span>‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ</span>
                </button>
              </div>
            </div>
          </div>

          <!-- right: schedule -->
          <div class="rounded-2xl p-5 bg-white/5 border border-white/10">
            <h3 class="font-semibold mb-3">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h3>
            <div class="grid sm:grid-cols-3 gap-3 items-end mb-4">
              <label class="flex items-center gap-2 sm:col-span-1">
                <input type="checkbox" id="schedEnabled" class="accent-emerald-400">
                <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
              </label>
              <div class="sm:col-span-2">
                <label class="block text-sm font-semibold mb-2">‡πÄ‡∏ß‡∏•‡∏≤ (HH:mm)</label>
                <input type="time" id="schedTime" class="input" value="08:30">
              </div>
            </div>

            <div class="mb-3">
              <div class="text-sm mb-2 font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
              <div id="weekdayWrap" class="grid grid-cols-7 gap-1 text-center"></div>
            </div>

            <label class="flex items-center gap-2 mb-4">
              <input type="checkbox" id="schedSkipHolidays" class="accent-emerald-400" checked>
              <span class="text-sm">‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏ä‡∏µ‡∏ï Holidays)</span>
            </label>

            <div class="flex flex-col sm:flex-row gap-3">
              <button id="saveSchedBtn" class="btn flex-1 py-3 font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á</button>
              <button id="reloadSchedBtn" class="btn sm:w-32 py-3 font-semibold">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>

            <div id="schedStatus" class="text-xs text-white/70 mt-3"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- status & popup -->
    <div id="status" class="hidden mt-6 p-4 rounded-2xl"></div>
    <div id="popup" class="hidden fixed inset-0 z-50 items-center justify-center p-6">
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="relative glass card p-6 max-w-sm w-full text-center">
        <div class="w-14 h-14 rounded-2xl bg-green-500/20 mx-auto mb-4 flex items-center justify-center">
          <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h3 class="text-xl font-semibold mb-2">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
        <p id="popupMsg" class="text-white/90 mb-4"></p>
        <button onclick="closePopup()" class="btn w-full py-2 font-semibold">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>

  <script>
    /* ================= CONFIG ================= */
    const APP_SCRIPT_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxKmlulJgGnv8pUqbbOYlK5mRn6jZ_DdQQCKoJ3dExHWl62mDOPhDR5usWbSpC38gzH/exec';

    /* ============ Local date helpers (‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á UTC shift) ============ */
    function toLocalISO(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function getWeekRange(offsetWeek=0){
      const now=new Date(); now.setHours(0,0,0,0);
      const day=now.getDay(); const diffToMon=(day===0?-6:1-day) + offsetWeek*7;
      const monday=new Date(now); monday.setDate(now.getDate()+diffToMon); monday.setHours(0,0,0,0);
      const friday=new Date(monday); friday.setDate(monday.getDate()+4); friday.setHours(0,0,0,0);
      return { start: toLocalISO(monday), end: toLocalISO(friday) };
    }

    /* ================= TABS ================= */
    const tabs = [
      {btn:'tab-1', panel:'panel-1'},
      {btn:'tab-2', panel:'panel-2'},
      {btn:'tab-3', panel:'panel-3'},
    ];
    function activateTab(idx){
      tabs.forEach((t,i)=>{
        document.getElementById(t.btn).setAttribute('aria-selected', i===idx?'true':'false');
        document.getElementById(t.panel).classList.toggle('active', i===idx);
      });
      localStorage.setItem('activeTab', String(idx));
    }
    tabs.forEach((t,i)=> document.getElementById(t.btn).addEventListener('click', ()=>activateTab(i)));
    const savedTab = Number(localStorage.getItem('activeTab'));
    if(!Number.isNaN(savedTab) && savedTab>=0 && savedTab<tabs.length) activateTab(savedTab);

    /* ================= UI basics ================= */
    const today = toLocalISO(new Date());
    const dateInput = document.getElementById('dateInput');
    dateInput.min = today; dateInput.value = today;
    document.getElementById('rangeStart').min = today;
    document.getElementById('rangeEnd').min = today;
    // tab3 date (send now)
    const sendDateInput = document.getElementById('sendDateInput');
    sendDateInput.min = today; sendDateInput.value = today;

    function toast(msg, type='info'){
      const el = document.getElementById('status');
      el.className = `mt-6 p-4 rounded-2xl ${type==='error'?'bg-red-500/20 border border-red-500/40':'bg-white/10 border border-white/20'}`;
      el.textContent = msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'), 4500);
    }
    function openPopup(text){ document.getElementById('popupMsg').textContent = text; document.getElementById('popup').classList.remove('hidden'); document.getElementById('popup').classList.add('flex'); }
    function closePopup(){ document.getElementById('popup').classList.add('hidden'); document.getElementById('popup').classList.remove('flex'); }

    function setBtnLoading(btn, isLoading, doneLabel='‡πÄ‡∏™‡∏£‡πá‡∏à', loadingLabel='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...'){
      if(isLoading){
        btn.disabled = true;
        btn.dataset.prev = btn.innerHTML;
        btn.innerHTML = `
          <span class="inline-flex items-center gap-2">
            <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            ${loadingLabel}
          </span>`;
      }else{
        btn.disabled = false;
        btn.innerHTML = btn.dataset.prev || doneLabel;
      }
    }

    /* ================= Toggle AM/PM ================= */
    let splitMode=false;
    const fullBtn=document.getElementById('fullBtn'), splitBtn=document.getElementById('splitBtn');
    const fullBox=document.getElementById('fullBox'), splitBox=document.getElementById('splitBox');
    fullBtn.addEventListener('click', ()=>{ splitMode=false; fullBtn.classList.add('bg-white/20'); splitBtn.classList.remove('bg-white/20'); fullBox.classList.remove('hidden'); splitBox.classList.add('hidden'); });
    splitBtn.addEventListener('click', ()=>{ splitMode=true;  splitBtn.classList.add('bg-white/20'); fullBtn.classList.remove('bg-white/20'); splitBox.classList.remove('hidden'); fullBox.classList.add('hidden'); });

    /* ================= API helper ================= */
    async function callAPI(action, payload={}){
      const fd = new FormData();
      fd.append('action', action);
      fd.append('payload', JSON.stringify(payload));
      const res = await fetch(APP_SCRIPT_WEBAPP_URL, { method:'POST', body: fd });
      const text = await res.text();
      try { return JSON.parse(text); } catch { return { ok:false, error:'Invalid JSON', raw:text }; }
    }

    /* ================= Suggestions ================= */
    const suggestWrap = document.getElementById('suggestWrap');
    const suggestEmpty = document.getElementById('suggestEmpty');
    const suggestLoading = document.getElementById('suggestLoading');

    async function refreshSuggestions(){
      const date = document.getElementById('dateInput').value;
      const name = document.getElementById('nameSelect').value.trim();
      if(!date){ return; }
      suggestWrap.innerHTML = ''; suggestEmpty.classList.add('hidden');
      suggestLoading.classList.remove('hidden');
      try{
        const {ok, items, error} = await callAPI('suggest', { date, excludeName: name || '' });
        suggestLoading.classList.add('hidden');
        if(!ok){ suggestWrap.innerHTML = `<div class="text-red-300 text-sm">${error || '‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}</div>`; return; }
        if(!items || !items.length){ suggestEmpty.classList.remove('hidden'); return; }
        suggestWrap.innerHTML = items.map(renderSuggestItem).join('');
      }catch(err){
        suggestLoading.classList.add('hidden');
        suggestWrap.innerHTML = `<div class="text-white/80 text-sm">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>`;
      }
    }
    function renderSuggestItem(it){
      const [pureLoc, part] = parsePart(it.location);
      const names = (it.names || []).join(' ');
      return `
        <div class="chip rounded-xl p-3">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-medium">${pureLoc} ${part?`<span class="text-xs text-white/70">${part}</span>`:''}</div>
              <div class="text-xs text-white/70">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (${it.count}): ${names}</div>
            </div>
            <div class="flex gap-2">
              <button class="mini-btn text-xs px-2 py-1 rounded-lg" onclick="useSuggest('${escapeHTML(pureLoc)}','both')">‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô</button>
              <button class="mini-btn text-xs px-2 py-1 rounded-lg" onclick="useSuggest('${escapeHTML(pureLoc)}','am')">AM</button>
              <button class="mini-btn text-xs px-2 py-1 rounded-lg" onclick="useSuggest('${escapeHTML(pureLoc)}','pm')">PM</button>
            </div>
          </div>
        </div>`;
    }
    function parsePart(locLabel){ const m=/(.*)\s+\((AM|PM)\)$/i.exec(locLabel||''); if(!m) return [locLabel,'']; return [m[1].trim(),`(${m[2].toUpperCase()})`]; }
    window.useSuggest = function(loc, mode){
      if(mode==='both'){
        if(!splitMode){ document.getElementById('fullLocation').value = loc; }
        else{ document.getElementById('amLocation').value = loc; document.getElementById('pmLocation').value = loc; }
      }else if(mode==='am'){ splitMode=true; splitBtn.click(); document.getElementById('amLocation').value = loc; }
      else if(mode==='pm'){ splitMode=true; splitBtn.click(); document.getElementById('pmLocation').value = loc; }
      toast(`‡πÉ‡∏™‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${loc} (${mode.toUpperCase()==='BOTH'?'‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô':mode.toUpperCase()})`);
    };
    document.getElementById('dateInput').addEventListener('change', refreshSuggestions);
    document.getElementById('nameSelect').addEventListener('change', refreshSuggestions);
    refreshSuggestions();

    /* ================= Submit (single day) ================= */
    const checkinBtn = document.getElementById('checkinBtn');
    document.getElementById('checkinForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('nameSelect').value.trim();
      const date = document.getElementById('dateInput').value;
      if(!name || !date){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô','error'); return; }
      if(date < today){ toast('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á','error'); return; }

      let payload;
      if(!splitMode){
        const loc = document.getElementById('fullLocation').value.trim();
        if(!loc){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô)','error'); return; }
        payload = { name, date, split:false, location:loc };
      }else{
        const am = document.getElementById('amLocation').value.trim();
        const pm = document.getElementById('pmLocation').value.trim();
        if(!am || !pm){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á AM ‡πÅ‡∏•‡∏∞ PM','error'); return; }
        payload = { name, date, split:true, amLoc:am, pmLoc:pm };
      }

      try{
        setBtnLoading(checkinBtn, true, 'Check In', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
        const {ok, upsert, error} = await callAPI('create', payload);
        if(!ok){ toast(error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); return; }
        openPopup(upsert ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        document.getElementById('fullLocation').value = 'Ari';
        document.getElementById('amLocation').value = 'Ari';
        document.getElementById('pmLocation').value = 'Ari';
        refreshSuggestions();
      }catch(err){ console.error(err); toast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠','error'); }
      finally{ setBtnLoading(checkinBtn, false, 'Check In'); }
    });

    /* ================= Bulk Create ================= */
    function buildCommonBulkPayload(){
      const name = document.getElementById('nameSelect').value.trim();
      if(!name){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô','error'); return null; }
      if(!splitMode){
        const loc = document.getElementById('fullLocation').value.trim();
        if(!loc){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô)','error'); return null; }
        return { name, split:false, location:loc };
      }else{
        const am = document.getElementById('amLocation').value.trim();
        const pm = document.getElementById('pmLocation').value.trim();
        if(!am || !pm){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á AM ‡πÅ‡∏•‡∏∞ PM','error'); return null; }
        return { name, split:true, amLoc:am, pmLoc:pm };
      }
    }
    const bulkThisWeekBtn = document.getElementById('bulkThisWeek');
    const bulkNextWeekBtn = document.getElementById('bulkNextWeek');
    const bulkRangeBtn   = document.getElementById('bulkRange');

    bulkThisWeekBtn.addEventListener('click', async ()=>{
      const base = buildCommonBulkPayload(); if(!base) return;
      const {start,end} = getWeekRange(0);
      const payload = { ...base, startDate:start, endDate:end, weekdaysOnly:true };
      try{
        setBtnLoading(bulkThisWeekBtn, true, '‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...');
        const res = await callAPI('bulkCreate', payload);
        if(!res.ok){ toast(res.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); return; }
        openPopup(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏û‡∏¥‡πà‡∏° ${res.created} ¬∑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${res.updated}${res.skippedPast?` ¬∑ ‡∏Ç‡πâ‡∏≤‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ${res.skippedPast}`:''}`);
      }catch(err){ console.error(err); toast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); }
      finally{ setBtnLoading(bulkThisWeekBtn, false, '‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ'); }
    });

    bulkNextWeekBtn.addEventListener('click', async ()=>{
      const base = buildCommonBulkPayload(); if(!base) return;
      const {start,end} = getWeekRange(1);
      const payload = { ...base, startDate:start, endDate:end, weekdaysOnly:true };
      try{
        setBtnLoading(bulkNextWeekBtn, true, '‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏´‡∏ô‡πâ‡∏≤', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...');
        const res = await callAPI('bulkCreate', payload);
        if(!res.ok){ toast(res.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); return; }
        openPopup(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏û‡∏¥‡πà‡∏° ${res.created} ¬∑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${res.updated}`);
      }catch(err){ console.error(err); toast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); }
      finally{ setBtnLoading(bulkNextWeekBtn, false, '‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏´‡∏ô‡πâ‡∏≤'); }
    });

    bulkRangeBtn.addEventListener('click', async ()=>{
      const base = buildCommonBulkPayload(); if(!base) return;
      const start = document.getElementById('rangeStart').value;
      const end   = document.getElementById('rangeEnd').value;
      if(!start || !end){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','error'); return; }
      if(end < start){ toast('‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°','error'); return; }
      const payload = { ...base, startDate:start, endDate:end, weekdaysOnly:false };
      try{
        setBtnLoading(bulkRangeBtn, true, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...');
        const res = await callAPI('bulkCreate', payload);
        if(!res.ok){ toast(res.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); return; }
        openPopup(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏û‡∏¥‡πà‡∏° ${res.created} ¬∑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${res.updated}`);
      }catch(err){ console.error(err); toast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); }
      finally{ setBtnLoading(bulkRangeBtn, false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'); }
    });

    /* ================= View schedule ================= */
    const viewBtn = document.getElementById('viewBtn');
    viewBtn.addEventListener('click', async ()=>{
      const name = document.getElementById('viewName').value.trim();
      if(!name){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ','error'); return; }
      setBtnLoading(viewBtn, true, '‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
      try{ await renderSchedule(name); } finally{ setBtnLoading(viewBtn, false, '‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á'); }
    });

    async function renderSchedule(name){
      const wrap = document.getElementById('scheduleWrap');
      const list = document.getElementById('scheduleList');
      wrap.classList.remove('hidden');
      list.innerHTML = `<div class="text-white/80">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;
      try{
        const {ok, items, error} = await callAPI('listFuture', { name, from: today });
        if(!ok){ list.innerHTML = `<div class="text-red-300">${error||'‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}</div>`; return; }
        if(!items || !items.length){ list.innerHTML = `<div class="text-white/80">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</div>`; return; }
        list.innerHTML = items.map(row => renderItem(row)).join('');
      }catch(err){ console.error(err); list.innerHTML = `<div class="text-white/80">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>`; }
    }
    function renderItem(entry){
      const locationDisplay = entry.split
        ? `<div class="text-sm text-white/90">üåÖ AM: ${entry.am || '-'}</div><div class="text-sm text-white/90">üåÜ PM: ${entry.pm || '-'}</div>`
        : `<div class="text-sm text-white/90">${entry.location || entry.am || '-'}</div>`;
      return `
        <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-semibold">${formatThai(entry.date)}</div>
              ${locationDisplay}
            </div>
            <button class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20"
              onclick="openEdit('${entry.rowId}', ${entry.split ? 'true':'false'}, '${entry.date}', '${escapeHTML(entry.am||'')}', '${escapeHTML(entry.pm||'')}', '${escapeHTML(entry.location||'')}')">
              ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
          </div>
          <div id="edit-${entry.rowId}" class="hidden mt-4 pt-4 border-t border-white/10"></div>
        </div>`;
    }
    function formatThai(iso){ const d=new Date(iso); const months=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.']; return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()+543}`; }
    function escapeHTML(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    /* ================= Edit ================= */
    window.openEdit = function(rowId, split, date, am, pm, location){
      const box = document.getElementById(`edit-${rowId}`); const isSplit=!!split;
      box.innerHTML = `
        <div class="space-y-3">
          <div><label class="block text-sm font-semibold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="ed-date-${rowId}" class="input" value="${date}" min="${today}"></div>
          <div><label class="block text-sm font-semibold mb-1">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
            <div class="flex pill p-1">
              <button type="button" id="ed-full-${rowId}" class="flex-1 py-2 rounded-xl ${!isSplit?'bg-white/20':''}">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô</button>
              <button type="button" id="ed-split-${rowId}" class="flex-1 py-2 rounded-xl ${isSplit?'bg-white/20':''}">‡πÅ‡∏¢‡∏Å AM/PM</button>
            </div>
          </div>
          <div id="ed-fullBox-${rowId}" class="${isSplit?'hidden':''}">
            <label class="block text-sm font-semibold mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)</label>
            <input type="text" id="ed-fullLoc-${rowId}" class="input" value="${location || am || ''}">
            <p class="text-xs text-white/70 mt-1">* ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AM ‡πÅ‡∏•‡∏∞ PM ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</p>
          </div>
          <div id="ed-splitBox-${rowId}" class="${isSplit?'':'hidden'} space-y-3">
            <div><label class="block text-sm font-semibold mb-1">üåÖ AM</label><input type="text" id="ed-am-${rowId}" class="input" value="${am || ''}"></div>
            <div><label class="block text-sm font-semibold mb-1">üåÜ PM</label><input type="text" id="ed-pm-${rowId}" class="input" value="${pm || ''}"></div>
          </div>
          <div class="flex gap-3 pt-2">
            <button id="saveBtn-${rowId}" class="btn flex-1 py-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="bg-white/10 hover:bg-white/20 flex-1 py-2 rounded-xl" onclick="closeEdit('${rowId}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </div>`;
      box.classList.remove('hidden');
      document.getElementById(`ed-full-${rowId}`).onclick = ()=>{ toggleEditMode(rowId,false); };
      document.getElementById(`ed-split-${rowId}`).onclick = ()=>{ toggleEditMode(rowId,true); };
      document.getElementById(`saveBtn-${rowId}`).onclick = async (e)=>{ e.preventDefault(); await saveEdit(rowId); };
    };
    function toggleEditMode(rowId,toSplit){ const fullBtn=document.getElementById(`ed-full-${rowId}`), splitBtn=document.getElementById(`ed-split-${rowId}`), fullBox=document.getElementById(`ed-fullBox-${rowId}`), splitBox=document.getElementById(`ed-splitBox-${rowId}`); if(toSplit){ splitBtn.classList.add('bg-white/20'); fullBtn.classList.remove('bg-white/20'); splitBox.classList.remove('hidden'); fullBox.classList.add('hidden'); }else{ fullBtn.classList.add('bg-white/20'); splitBtn.classList.remove('bg-white/20'); fullBox.classList.remove('hidden'); splitBox.classList.add('hidden'); } }
    window.closeEdit = function(rowId){ document.getElementById(`edit-${rowId}`).classList.add('hidden'); };

    async function saveEdit(rowId){
      const date = document.getElementById(`ed-date-${rowId}`).value;
      if(!date){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','error'); return; }
      if(date < today){ toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ','error'); return; }
      const fullVisible = !document.getElementById(`ed-fullBox-${rowId}`).classList.contains('hidden');
      const saveBtn = document.getElementById(`saveBtn-${rowId}`);
      let payload = { rowId, date };
      if(fullVisible){
        const loc = document.getElementById(`ed-fullLoc-${rowId}`).value.trim();
        if(!loc){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô)','error'); return; }
        payload.split = false; payload.location = loc;
      }else{
        const am = document.getElementById(`ed-am-${rowId}`).value.trim();
        const pm = document.getElementById(`ed-pm-${rowId}`).value.trim();
        if(!am || !pm){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á AM ‡πÅ‡∏•‡∏∞ PM','error'); return; }
        payload.split = true; payload.amLoc = am; payload.pmLoc = pm;
      }
      try{
        setBtnLoading(saveBtn, true, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
        const {ok, error} = await callAPI('update', payload);
        if(!ok){ toast(error || '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); return; }
        openPopup('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        const name = document.getElementById('viewName').value.trim(); if(name) renderSchedule(name);
      }catch(err){ console.error(err); toast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠','error'); }
      finally{ setBtnLoading(saveBtn, false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); }
    }

    /* ================= LINE Sender ================= */
    const weekdayWrap = document.getElementById('weekdayWrap');
    const dowLabels = ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™']; // 0..6 (JS)
    const isoDowToJsIndex = d => (d % 7); // 1..7 -> 1..6,0
    const jsIndexToIso = i => (i === 0 ? 7 : i); // 0..6 -> 7,1..6

    const dayButtons = [];
    (function buildWeekButtons(){
      for(let i=0;i<7;i++){
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'px-2 py-2 rounded-lg bg-white/10 hover:bg-white/20';
        b.textContent = dowLabels[i];
        b.dataset.active = (i>=1 && i<=5) ? '1':'0'; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏à‚Äì‡∏®
        toggleDayVisual(b);
        b.addEventListener('click', ()=>{ b.dataset.active = b.dataset.active === '1' ? '0':'1'; toggleDayVisual(b); });
        weekdayWrap.appendChild(b);
        dayButtons.push(b);
      }
    })();
    function toggleDayVisual(btn){
      if(btn.dataset.active === '1'){
        btn.classList.add('bg-emerald-500/20','border','border-emerald-400/40');
      } else {
        btn.classList.remove('bg-emerald-500/20','border','border-emerald-400/40');
      }
    }

    async function loadSchedule(){
      const {ok, config, error} = await callAPI('getSchedule', {});
      if(!ok){ document.getElementById('schedStatus').textContent = error || '‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; return; }
      document.getElementById('schedEnabled').checked = !!config.enabled;
      document.getElementById('schedTime').value = config.time || '08:30';
      document.getElementById('schedSkipHolidays').checked = !!config.skipHolidays;

      dayButtons.forEach((b,i)=>{ b.dataset.active='0'; toggleDayVisual(b); });
      (config.days || [1,2,3,4,5]).forEach(iso=>{
        const idx = isoDowToJsIndex(iso);
        dayButtons[idx].dataset.active = '1';
        toggleDayVisual(dayButtons[idx]);
      });

      document.getElementById('schedStatus').textContent =
        config.enabled
          ? `‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${config.time} (‡∏ß‡∏±‡∏ô: ${config.days.join(',')})`
          : '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏¢‡∏π‡πà';
    }
    loadSchedule();
    document.getElementById('reloadSchedBtn').addEventListener('click', loadSchedule);

    document.getElementById('saveSchedBtn').addEventListener('click', async ()=>{
      const btn = document.getElementById('saveSchedBtn');
      const enabled = document.getElementById('schedEnabled').checked;
      const time = document.getElementById('schedTime').value;
      const skipHolidays = document.getElementById('schedSkipHolidays').checked;

      const days = dayButtons
        .map((b,i)=> b.dataset.active==='1' ? jsIndexToIso(i) : null)
        .filter(Boolean);

      if(!/^\d{2}:\d{2}$/.test(time)){ toast('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (HH:mm)','error'); return; }
      if(enabled && days.length===0){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô','error'); return; }

      try{
        setBtnLoading(btn, true, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
        const res = await callAPI('saveSchedule', { enabled, time, days, skipHolidays });
        if(!res.ok){ toast(res.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); return; }
        toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        loadSchedule();
      } finally { setBtnLoading(btn, false, '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á'); }
    });

    // ‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö 3)
    document.getElementById('sendNowBtn').addEventListener('click', async ()=>{
      const btn = document.getElementById('sendNowBtn');
      const date = document.getElementById('sendDateInput').value;
      if(!date){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô','error'); return; }
      try{
        setBtnLoading(btn, true, '‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...');
        const res = await callAPI('pushNow', { date });
        if(!res.ok){ toast(res.error || '‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); return; }
        openPopup('‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      } finally { setBtnLoading(btn, false, '‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ'); }
    });
  </script>
</body>
</html>
